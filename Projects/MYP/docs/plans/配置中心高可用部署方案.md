# 配置中心高可用部署方案

## 1. 概述

为了提高系统的可用性和可靠性，我们需要实现配置中心的高可用部署。本方案详细描述了如何将当前的单节点配置中心升级为高可用集群。

## 2. 部署架构

### 2.1 整体架构

![配置中心高可用架构](https://example.com/config-center-ha-architecture.png)

- 采用**一主多从**的Git仓库架构存储配置
- 部署**至少3个**配置中心节点，实现集群高可用
- 配置中心节点注册到Eureka服务注册中心
- 其他服务通过Eureka发现配置中心集群

### 2.2 节点分布

- 节点1: 192.168.1.101:8888
- 节点2: 192.168.1.102:8888
- 节点3: 192.168.1.103:8888

## 3. 实施步骤

### 3.1 准备Git仓库

1. 创建主Git仓库: `https://github.com/example/myp-config.git`
2. 创建至少2个从Git仓库，用于备份
3. 将当前`configs`目录下的配置文件提交到主Git仓库

### 3.2 修改配置服务配置

1. 修改`application.yml`，配置Git仓库信息和Eureka注册
2. 添加`bootstrap.yml`，解决Eureka和配置中心的循环依赖问题
3. 配置健康检查和故障转移机制

### 3.3 构建和部署配置中心集群

1. 构建配置中心镜像
2. 在多个节点上部署配置中心
3. 配置负载均衡

### 3.4 验证高可用配置

1. 停止其中一个配置中心节点，检查其他节点是否正常工作
2. 修改Git仓库中的配置，检查配置是否能够正确同步到所有节点
3. 验证其他服务是否能够从配置中心获取配置

## 4. 配置文件修改

### 4.1 修改application.yml

```yaml
server:
  port: 8888

spring:
  application:
    name: config-service
  cloud:
    config:
      server:
        git:
          uri: https://github.com/example/myp-config.git
          search-paths: '{application}'
          default-label: main
          timeout: 5
          force-pull: true
          # 配置从仓库
          repos:
            secondary:
              pattern: '*/secondary'
              uri: https://github.com/example/myp-config-secondary.git
              search-paths: '{application}'
              default-label: main

# 配置Eureka客户端
# 配置中心需要注册到Eureka，以便其他服务能够发现
# 注意：需要在bootstrap.yml中配置Eureka的地址，避免循环依赖

# 健康检查配置
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always

# 日志配置
logging:
  level:
    root: INFO
    org.springframework.cloud.config: DEBUG
```

### 4.2 添加bootstrap.yml

```yaml
# bootstrap.yml
spring:
  application:
    name: config-service
  cloud:
    config:
      fail-fast: true
      retry:
        max-attempts: 6
        initial-interval: 1000
        multiplier: 1.1
        max-interval: 2000

# 配置Eureka地址，避免循环依赖
# 这里直接配置Eureka地址，而不是从配置中心获取
# 在实际部署中，可以根据环境变量或系统属性进行配置
eureka:
  client:
    serviceUrl:
      defaultZone: http://eureka-server1:8761/eureka/,http://eureka-server2:8762/eureka/
  instance:
    preferIpAddress: true
    instanceId: ${spring.cloud.client.ip-address}:${server.port}
```

## 5. 注意事项

1. 确保Git仓库有适当的访问权限
2. 配置中心节点数至少为3个，以确保高可用性
3. 生产环境中应使用HTTPS协议访问Git仓库
4. 定期备份Git仓库中的配置
5. 配置中心集群应部署在不同的物理节点上，避免单点故障
6. 监控配置中心的健康状态，及时发现和解决问题

## 6. 故障处理

### 6.1 Git仓库不可用

- 配置中心会使用本地缓存的配置
- 启动时如果Git仓库不可用，配置中心会尝试使用本地缓存
- 可以配置多个Git仓库，实现Git仓库的高可用

### 6.2 配置中心节点故障

- 其他节点会继续提供服务
- Eureka会自动将故障节点从服务列表中移除
- 服务会自动切换到可用的配置中心节点

### 6.3 网络故障

- 配置中心客户端会缓存配置
- 网络恢复后，会自动同步最新配置

## 7. 性能优化

1. 配置缓存：启用配置中心客户端缓存
2. 减少配置更新频率：避免频繁更新配置
3. 合理设置配置中心节点数：根据系统规模和负载设置适当的节点数
4. 优化Git仓库访问：使用本地Git仓库镜像或缓存