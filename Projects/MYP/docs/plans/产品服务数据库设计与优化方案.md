# 产品服务数据库设计与优化方案

## 1. 概述

本方案旨在优化产品服务的数据库设计，提高系统性能、可用性和可扩展性。基于当前产品服务的代码实现和业务需求，提出以下优化建议。

## 2. 当前数据库设计分析

### 2.1 现有表结构

目前产品服务只有一个`products`表，对应`Product`实体类，结构如下：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| name | VARCHAR(100) | 产品名称 |
| description | TEXT | 产品描述 |
| price | DECIMAL(10,2) | 产品价格 |
| stock_quantity | INT | 库存数量 |
| status | INT | 状态(0:禁用, 1:启用) |
| category_id | BIGINT | 分类ID |
| tenant_id | BIGINT | 租户ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 2.2 现有问题

1. 缺乏适当的索引，可能导致查询性能问题
2. 数据库连接池配置未优化
3. 未充分利用缓存减少数据库访问压力
4. 未考虑数据量增长后的分表分库策略
5. 日志记录不充分，难以追踪数据库操作问题

## 3. 优化方案

### 3.1 索引优化

添加以下索引以提高查询性能：

```sql
-- 为常用查询字段添加索引
CREATE INDEX idx_products_tenant_id ON products(tenant_id);
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_tenant_id_status ON products(tenant_id, status);
```

### 3.2 连接池优化

修改`application.yml`配置，优化数据库连接池：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/product_service?useSSL=false&serverTimezone=UTC
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

### 3.3 缓存策略优化

充分利用Redis缓存频繁访问的产品数据：

1. 缓存常用查询结果，如热门产品列表
2. 设置合理的缓存过期时间
3. 实现缓存预热机制
4. 缓存一致性维护（更新产品时清除对应缓存）

### 3.4 数据分片策略

为应对未来数据量增长，可考虑以下分片策略：

1. 按租户ID分片：不同租户的数据存储在不同的数据库或表中
2. 按产品分类分片：不同分类的产品存储在不同的表中

### 3.5 查询优化

1. 避免全表扫描，确保查询使用索引
2. 合理使用分页查询，避免一次性返回大量数据
3. 仅查询必要字段，减少数据传输量
4. 复杂查询可考虑使用视图或存储过程

### 3.6 日志与监控

添加数据库操作日志和性能监控：

```yaml
logging:
  level:
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

# 可添加Actuator端点监控数据库连接池状态
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
```

## 4. 实施步骤

1. **索引优化**：在测试环境创建索引，验证性能提升后应用到生产环境
2. **连接池优化**：修改配置文件，重启服务
3. **缓存策略优化**：实现缓存逻辑，更新产品服务代码
4. **数据分片策略**：根据数据增长情况，在适当时候实施分片
5. **查询优化**：审查现有查询，优化慢查询
6. **日志与监控**：添加日志和监控配置

## 5. 风险评估

1. **索引优化风险**：过多索引可能影响写性能，需平衡读写需求
2. **连接池优化风险**：连接池设置过大可能导致数据库连接耗尽
3. **缓存策略风险**：缓存不一致可能导致数据错误
4. **数据分片风险**：分片实施复杂，需充分测试

## 6. 性能监控与持续改进

1. 定期分析数据库慢查询日志
2. 监控索引使用情况
3. 监控连接池状态
4. 根据监控数据持续调整优化策略